function nl2br(t,e){var i=e||"undefined"==typeof e?"<br />":"<br>";return(t+"").replace(/([^>\r\n]?)(\r\n|\n\r|\r|\n)/g,"$1"+i+"$2")}function getNotDone(t){return _.where(t,{is_done:0})}$.fn.editable.defaults.ajaxOptions={type:"put"},$(".btn").button();var taskCategoriesCollection=new(Backbone.Collection.extend({url:"/task-categories"}))(taskCategories),taskTagsCollection=new(Backbone.Collection.extend({url:"/task-tags"}))(taskTags),tasksCollection=new(Backbone.Collection.extend({model:Backbone.Model.extend({url:function(){return"/tasks/"+this.id},currentTag:function(){var t=actionModel.get("activeCategory"),e=this.get("tags").filter(function(e){return e.tag_category_id===t});return e.length>0?e[0]:(console.error("tag not found for categoryid "+t),{})},currentOrder:function(){var t=actionModel.get("activeCategory"),e=this.get("orders").filter(function(e){return e.tag_category_id===t});return e.length>0?e[0].order:0},setArchived:function(){this.set({archived:!0}),$.post("/task/"+this.get("id")+"/set-archived")},unsetArchived:function(){$.post("/task/"+this.get("id")+"/unset-archived")}})})),actionModel=new(Backbone.Model.extend({save:function(){window.localStorage.setItem("taskActionConfig",JSON.stringify(this.toJSON()))},initialize:function(){taskActionConfig=JSON.parse(window.localStorage.getItem("taskActionConfig"))||{activeCategory:1},this.set(taskActionConfig)}})),actionView=new(Backbone.View.extend({collection:taskCategoriesCollection,model:actionModel,events:{"change #control-archived":function(t){return $(t.currentTarget).is(":checked")?void this.model.set({showArchived:!0}):void this.model.set({showArchived:!1})},"click [data-categoryid]":function(t){var e=$(t.currentTarget).data("categoryid"),i=this.collection.get(e);i&&this.setActiveCategory(i)},"click #new-group":function(t){bootbox.prompt("New Group Name",function(t){t&&t.trim()&&this.collection.create({name:t.trim()},{success:function(t){this.setActiveCategory(t),window.location.reload(!0)}.bind(this)})}.bind(this))},"click #del-group":function(t){bootbox.confirm("Are you sure you want to remove this group?",function(t){var e=this.collection.pluck("id");if(t&&e.length>=2){var i=this.model.get("activeCategory"),n=_.without(e,i).shift(),o=this.collection.get(n);this.setActiveCategory(o),this.collection.get(i).destroy()}}.bind(this))},"click #new-heading":function(t){bootbox.prompt("New Tag Name",function(t){t&&t.trim()&&taskTagsCollection.create({name:t.trim(),tag_category_id:this.model.get("activeCategory"),label:"default"},{success:function(t){window.location.reload(!0)}.bind(this)})}.bind(this))}},setActiveCategory:function(t){this.model.set("activeCategory",t.id).save(),this.$activeCategory.text(t.get("name")),$(".group-name",this.$el).text(t.get("name"))},render:function(){this.$menu.html("");var t=this.model.get("activeCategory");this.collection.each(function(e){e.id===t&&this.setActiveCategory(e),this.$menu.append('<li data-categoryid="'+e.id+'"><a>'+e.get("name")+"</a></li>")}.bind(this)),this.model.get("showArchived")?$("#control-archived",this.$el).attr("checked",!0):$("#control-archived",this.$el).attr("checked",!1)},initialize:function(){this.$menu=$("#group-menu",this.$el),this.$activeCategory=$("#active-category",this.$el);var t=_.debounce(function(){this.render()}.bind(this),16);this.listenTo(this.collection,"all",t),this.listenTo(this.model,"all",t),t()}}))({el:"#groups"}),taskHeadingsView=new(Backbone.View.extend({tags:taskTagsCollection,model:actionModel,template:_.template($("#task-headings-template").text()),handleTagDrop:_.debounce(function(t,e){var i=$(e.item[0]),n=i.data("tagid");if(n){var o=this.collection.get(n),a=i.parents(".panels").attr("id"),s=$(".panel").index(i);o.get("placement")!==a&&o.set({placement:a}).save(),o.get("order")!==s&&$(".panel").each(function(t,e){this.collection.get($(e).data("tagid")).set({order:t}).save()}.bind(this))}},16),render:function(){this.collection&&(this.taskHeadingViews.forEach(function(t,e){t.unbind(),t.remove()}),this.$el.html(this.template()),this.collection.each(function(t){this.taskHeadingViews.push(new taskHeadingView(t))}.bind(this)),$(".panels").sortable({start:function(){isNotDragging=!1},stop:function(){isNotDragging=!0},connectWith:".panels",placeholder:"ui-state-highlight",handle:".panel-heading",update:this.handleTagDrop.bind(this)}).disableSelection())},setCollection:function(){var t=this;this.collection=new(Backbone.Collection.extend({comparator:function(t,e){return t.get("order")>e.get("order")?1:-1},initialize:function(){return setTimeout(function(){t.render()},1),this}}))(taskTagsCollection.where({tag_category_id:this.model.get("activeCategory")}))},initialize:function(){this.taskHeadingViews=[];var t=_.debounce(function(){this.setCollection()}.bind(this),16);this.listenTo(this.model,"all",t),t()}}))({el:"#task-headings"}),tagChange=!1,timeout,isNotDragging=!0,taskHeadingView=Backbone.View.extend({template:_.template($("#task-heading-template").text()),events:{"click .create-todo":"create","click .new-input":function(t){$(t.currentTarget).focus()},"keyup .new-input":function(t){if(13===t.keyCode&&t.shiftKey)return this.create(),t.preventDefault(),!1},"click .editable-remove":function(t){clearTimeout(timeout),timeout=setTimeout(function(){var e=$(t.target).parents(".panel"),i=e.data("tagid");if(i){var n=taskTagsCollection.get(i);bootbox.confirm("Are you sure you want to delete "+n.get("name")+"?",function(t){t&&(n.destroy(),e.remove(),window.location.reload())})}},17)}},create:function(){var t=$(".new-input",this.element),e=t.val().trim();return e&&($.post("/tasks",{description:e,tag_id:this.model.get("id"),category_id:this.model.get("tag_category_id")}),t.val("")),!0},handleTaskDrop:function(t,e){var i=$(e.item[0]),n=i.data("taskid"),o=i.parents(".panel"),a=o.data("tagid"),s=this.model.toJSON();if(n&&a)if(s.id!==a){var r=tasksCollection.get(n);tagChange=!0,$.get("/tasks/"+r.id+"/set-tag/"+a,function(t){$.post("/task/set-order/"+s.tag_category_id,{order:o.find("li").map(function(t,e){return $(e).data("taskid")}).toArray()},function(){tagChange=!1})})}else tagChange||$.post("/task/set-order/"+s.tag_category_id,{order:o.find("li").map(function(t,e){return $(e).data("taskid")}).toArray()},function(){tagChange=!1})},renderChildren:function(){var t=this.model.id,e=actionModel.get("showArchived");$(".inner-task",this.element).html(""),tasksCollection.filter(function(e){return e.get("tags").map(function(t){return t.id}).indexOf(t)>-1}).sort(function(t,e){return t.get("archived")?1:e.get("archived")?-1:t.currentOrder()>e.currentOrder()?1:-1}).forEach(function(t){t.get("archived")&&e?this.taskViews.push(new taskView({el:$(".inner-task",this.element),model:t})):0===t.get("archived")&&this.taskViews.push(new taskView({el:$(".inner-task",this.element),model:t}))}.bind(this)),$(".inner-task",this.element).sortable({start:function(){isNotDragging=!1},stop:function(){isNotDragging=!0},connectWith:".inner-task",placeholder:"ui-state-highlight",update:_.debounce(this.handleTaskDrop,17).bind(this)}).disableSelection()},render:function(){this.element=$(this.template()),this.element.appendTo(this.$el),is_admin&&$(".panel-title",this.element).editable(),this.renderChildren()},initialize:function(t){this.taskViews=[],this.model=t,this.$el=$("#"+this.model.get("placement")),this.render(),this.listenTo(tasksCollection,"add change remove",_.debounce(function(){isNotDragging&&this.renderChildren()},100).bind(this))}}),taskViews={},taskView=Backbone.View.extend({events:{"click .category-label":function(t){var e=taskCategoriesCollection.get($(t.currentTarget).data("categoryid"));actionView.setActiveCategory(e)},"click img":function(t){TaskInfoModalView.setId(this.model.id)},"click .archive":function(){this.model.setArchived()},"click .unarchive":function(){this.model.unsetArchived()},"click .delete":function(){bootbox.confirm("Are you sure you want to delete this task?",function(t){t&&this.model.destroy()}.bind(this))}},template:_.template($("#task-template").text()),render:function(){this.$el=$('<li data-taskid="'+this.model.get("id")+'" />').html(this.template({model:this.model.toJSON(),currentCategoryId:actionModel.get("activeCategory")})),this.$el.appendTo(this.parent),$("[data-toggle=tooltip]").tooltip()},initialize:function(t){this.parent=this.$el,this.model=t.model,this.render()}}),TaskInfoModalView=new(Backbone.View.extend({id:null,data:{},followerTemplate:_.template(' <li class="is-follower" data-toggle="tooltip" title="<%-first_name%> <%-last_name%>" data-userid="<%-user_id%>"> <a href="#" class="user-avatar"><img width="100%" src="<%-(user_image) ? user_image.replace("original", "avatar") : "/images/user.jpg"%>"></a> </li> '),subtaskTemplate:_.template(' <li class="list-group-item <%if(is_done){%>is_done<%}%>"> <%if(is_done){%><button class="btn btn-danger btn-sm pull-right delete-subtask" data-subtaskid="<%-id%>">Ã—</button><%}%> <label><input type="checkbox" data-subtaskid="<%-id%>" <%if(is_done){%>checked<%}%> class="subtask-set-done"> <%-name%></label></li> '),events:{"click .is-follower":function(t){var e=$(t.currentTarget);$(".is-follower").index(e[0])>0&&bootbox.confirm("Are you sure you want to remove this follower?",function(t){t&&$.get("/tasks/"+this.id+"/remove-follower/"+e.data("userid"),function(){this.reload()}.bind(this))}.bind(this))},"click .delete-subtask":function(t){bootbox.confirm("Are you sure you want to delete this subtask?",function(e){e&&$.ajax({method:"DELETE",url:"/subtasks/"+$(t.target).data("subtaskid")}).success(function(){this.reload()}.bind(this))}.bind(this))},"change .subtask-set-done":function(t){var e=$(t.currentTarget);e.is(":checked")?$.get("/subtasks/"+e.data("subtaskid")+"/set-done",function(){this.reload()}.bind(this)):$.get("/subtasks/"+e.data("subtaskid")+"/set-undone",function(){this.reload()}.bind(this))},"keyup #new-subtask":function(t){var e=$(t.currentTarget),i=e.val().trim();13===t.keyCode&&t.shiftKey&&i&&($.post("/subtasks",{todo_id:this.id,name:i},function(){this.reload()}.bind(this)),e.val(""))},"click .delete-task":function(){bootbox.confirm("Are you sure you want to delete this task?",function(t){var e=tasksCollection.get(this.id);t&&e&&(e.destroy(),this.$el.modal("hide"),$.notify("Task deleted.","success"))}.bind(this))},"click .archive-task":function(){var t=tasksCollection.get(this.id);t&&(t.set({archived:1}).save(),this.reload())},"click .unarchive-task":function(){var t=tasksCollection.get(this.id);t&&(t.set({archived:0}).save(),this.reload())}},setId:function(t){this.id=t,TaskNoteView.setId(t),this.reload()},populate:function(){$(".is-follower",this.el).remove(),this.data.followers.forEach(function(t){t.id!==this.data.owner.id&&$(".followers",this.el).prepend(this.followerTemplate(t.profile))}.bind(this));var t;$(".followers",this.el).prepend(this.followerTemplate(this.data.owner.profile)).sortable({start:function(e,i){t=$(".is-follower").first()[0]},update:function(e,i){$(".is-follower").first()[0]!==t&&$.get("/tasks/"+this.id+"/set-owner/"+$(".is-follower").first().data("userid"),function(){}.bind(this))}.bind(this)}),$("#subtasks-list").html(""),this.data.subtasks.sort(function(t,e){return t.is_done?-1:e.is_done?1:new Date(t.created_at).getTime()>new Date(e.created_at).getTime()?1:-1}).forEach(function(t){$("#subtasks-list").prepend(this.subtaskTemplate(t))}.bind(this)),$(".unarchive-task,.archive-task").hide(),this.data.archived?$(".unarchive-task").show():$(".archive-task").show(),$(".modal-title").editable("destroy").text(this.data.description).data("value",this.data.description).editable({value:this.data.description,success:function(t,e){var i=tasksCollection.get(this.id),e=e.trim();i&&e&&(i.set({description:e}).save(),this.reload())}.bind(this)}),$("[data-toggle=tooltip]").tooltip(),this.show()},reload:function(){$.get("/taskinfo/"+this.id,function(t){this.data=t,this.populate()}.bind(this))},show:function(){this.$el.modal("show")},initialize:function(){$("#add-follower").editable({display:function(){return"+"},success:function(t,e){$.get("/tasks/"+this.id+"/add-follower/"+e,function(){this.reload()}.bind(this))}.bind(this)})}}))({el:"#task-info"}),format_date=function(t){return $.datepicker.formatDate(app_locale.long_date,new Date(t))+" @ "+t.split(" ").pop()},TaskNoteView=new(Backbone.View.extend({id:null,data:[],isEditing:!1,activeNoteTemplate:_.template('<div class="panel-heading"><h3 class="panel-title"><%-format_date(updated_at)%></h3></div><div class="panel-body"><%=nl2br(note)%></div><div class="panel-footer text-right"><a class="btn btn-primary btn-sm" id="edit-note" data-noteid="<%-id%>">Edit</a> <a class="btn btn-danger btn-sm" data-noteid="<%-id%>" id="delete-note">Delete</a></div>'),noteLiTemplate:_.template('<li data-noteid="<%-id%>"><a href="#" data-toggle="tooltip" data-title=""><%-note.substr(0, 20)%></a></li>'),events:{"keyup #note-content":function(t){13===t.keyCode&&t.shiftKey&&this.saveNote()},"click #add-new-note":function(){this.isEditing=!1,$("#active-note").hide(),$("#new-note").show(),$("#note-content").val("").focus(),$(".note-titles li").removeClass("active"),$("#note-input-title").text("New Note")},"click #save-new-note":"saveNote","click .note-titles li":function(t){var e=$(t.currentTarget);this.showNote(e.data("noteid"))},"click #delete-note":function(t){var e=$(t.currentTarget);bootbox.confirm("Are you sure you want to delete this note?",function(t){t&&$.ajax({method:"DELETE",url:"/tasks/"+e.data("noteid")+"/notes"}).success(function(){this.reload()}.bind(this))}.bind(this))},"click #edit-note":function(t){var e=$(t.currentTarget),i=_.findWhere(this.data,{id:e.data("noteid")});i&&(this.isEditing=i.id,$("#note-input-title").text("Editing"),$("#note-content").val(i.note),$("#active-note").hide(),$("#new-note").show(),$("#note-content").focus())}},saveNote:function(){var t=$("#note-content").val().trim();t&&(this.isEditing?$.ajax({method:"PUT",data:{note:t},url:"/tasks/"+this.isEditing+"/notes"}).success(function(){this.reload()}.bind(this)):($.post("/tasks/"+this.id+"/notes",{note:t},function(t){this.reload()}.bind(this)),$("#note-content").val("")))},showNote:function(t){var e=_.findWhere(this.data,{id:t});$("#new-note").hide(),$(".note-titles li").removeClass("active"),$('[data-noteid="'+t+'"]').addClass("active"),$(".panel-primary",$("#active-note")[0]).html(this.activeNoteTemplate(e)),$("#active-note").show()},setId:function(t){this.id=t,this.reload()},reload:function(){$.get("/tasks/"+this.id+"/notes",function(t){this.data=t,this.render()}.bind(this))},render:function(){$(".note-titles").html(""),this.data.forEach(function(t){$(".note-titles").append(this.noteLiTemplate(t))}.bind(this)),this.data.length>0?this.showNote(this.data[0].id):$("#add-new-note").trigger("click")},initialize:function(){$("#new-note").hide(),autosize($("#note-content")),$("#active-note").hide()}}))({el:"#notes"});